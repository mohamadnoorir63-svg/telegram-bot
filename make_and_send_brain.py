# make_and_send_brain.py
import os, json, zipfile, random, asyncio, datetime
from telegram import Bot, InputFile

# Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
BASE = os.path.dirname(os.path.abspath(__file__))
OUT_JSON = os.path.join(BASE, "memory.json")

# ğŸ§  Ù†Ø§Ù… ÙØ§ÛŒÙ„ ZIP Ø¨Ø§ ØªØ§Ø±ÛŒØ® Ø¬Ø¯ÛŒØ¯ ØªØ§ Ú©Ø´ ØªÙ„Ú¯Ø±Ø§Ù… Ù†Ø´ÙˆØ¯
timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
OUT_ZIP  = os.path.join(BASE, f"khengol_brain_{timestamp}.zip")

# ================== Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ ==================
MOODS = {
    "ğŸ˜ Ø´ÙˆØ®": ["ğŸ˜‚ Ø®Ù†Ø¯ÛŒØ¯Ù… Ø¨Ù‡ Ø­Ø±ÙØª!", "Ø¹Ù‡ Ø¬Ø¯ÛŒ Ú¯ÙØªÛŒØŸ ğŸ˜‚", "ØªÙˆ Ø®ÛŒÙ„ÛŒ Ø¨Ø§Ø­Ø§Ù„ÛŒ ğŸ˜", "Ø¯Ø§Ø±Ù… Ø§Ø² Ø®Ù†Ø¯Ù‡ Ù…ÛŒâ€ŒÙ…ÛŒØ±Ù… ğŸ¤£", "Ø®Ù†Ú¯ÛŒ ÙˆÙ„ÛŒ Ø¯ÙˆØ³Øªâ€ŒØ¯Ø§Ø´ØªÙ†ÛŒ ğŸ˜‚"],
    "ğŸ«¶ Ø§Ø­Ø³Ø§Ø³ÛŒ": ["Ø¯Ù„Ù… Ø¨Ø±Ø§Øª ØªÙ†Ú¯ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ ğŸ˜¢", "ØªÙˆ Ù‡Ù…ÛŒØ´Ù‡ Ø®Ø§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ù† ğŸ’–", "Ú†Ù‚Ø¯Ø± Ø­Ø³ Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø¯ÛŒ ğŸ˜", "Ø¢Ø±ÙˆÙ… Ø¨Ø§Ø´ØŒ Ù…Ù† Ú©Ù†Ø§Ø±Øªâ€ŒØ§Ù… ğŸ’«", "Ø§ÛŒ Ú©Ø§Ø´ Ù…ÛŒâ€ŒØªÙˆÙ†Ø³ØªÙ… Ø¨ØºÙ„Øª Ú©Ù†Ù… ğŸ¤—"],
    "ğŸ˜¡ ØªÙ†Ø¯": ["Ø­Ø±Ù Ø¯Ù‡Ù†ØªÙˆ Ø¨ÙÙ‡Ù… ğŸ˜¤", "Ø²ÛŒØ§Ø¯ Ø­Ø±Ù Ù†Ø²Ù† ğŸ˜’", "Ù…ÙˆØ§Ø¸Ø¨ Ù„Ø­Ù†ÙØª Ø¨Ø§Ø´ ğŸ˜ ", "Ø¯Ø§Ø±ÛŒ Ø±Ùˆ Ø§Ø¹ØµØ§Ø¨Ù… Ø±Ø§Ù‡ Ù…ÛŒØ±ÛŒ ğŸ˜‘", "Ø®ÙÙ‡ Ø´Ùˆ Ø¯ÛŒÚ¯Ù‡ ğŸ˜¡"],
    "ğŸ§  Ø¹Ø§Ø¯ÛŒ": ["Ø¢Ø±Ù‡ØŒ Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù… ğŸ™‚", "Ø¨Ø§Ø´Ù‡ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡...", "Ø¬Ø§Ù„Ø¨Ù‡ ğŸ¤”", "Ù…Ù†Ù… Ù‡Ù…ÛŒÙ† ÙÚ©Ø±Ùˆ Ù…ÛŒâ€ŒÚ©Ø±Ø¯Ù… ğŸ˜Œ", "Ø¯Ø±Ø³ØªÙ‡ âœ…"],
}

# ================== Ø¬Ù…Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ ==================
BASE_PHRASES = [
    "Ø³Ù„Ø§Ù…","Ø®ÙˆØ¨ÛŒ","Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒ","Ø¯ÙˆØ³ØªØª Ø¯Ø§Ø±Ù…","Ú†ØªÙ‡","Ø®ÙÙ‡ Ø´Ùˆ","Ú©Ø¬Ø§ÛŒÛŒ","Ø¨Ø±Ùˆ Ø¨Ø®ÙˆØ§Ø¨","Ø¯Ù„Øª Ø¨Ø±Ø§Ù… ØªÙ†Ú¯ Ø´Ø¯Ù‡","Ú†ÛŒ Ø®ÙˆØ±Ø¯ÛŒ",
    "Ú†Ø±Ø§ Ø³Ø§Ú©ØªÛŒ","ØµØ¨Ø­ Ø¨Ø®ÛŒØ±","Ø´Ø¨ Ø¨Ø®ÛŒØ±","Ø­ÙˆØµÙ„Ù… Ø³Ø± Ø±ÙØªÙ‡","Ù…ÛŒâ€ŒØ®ÙˆØ§Ù… Ø¨Ø®Ù†Ø¯Ù…","Ú†Ø±Ø§ Ù†Ø§Ø±Ø§Ø­ØªÛŒ","Ú†Ù‚Ø¯Ø± Ø­Ø±Ù Ù…ÛŒâ€ŒØ²Ù†ÛŒ","Ø¨ÛŒÚ©Ø§Ø±ÛŒ",
    "Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ù…Ù†Ùˆ","Ú†Ø±Ø§ Ø¯ÛŒØ± Ø¬ÙˆØ§Ø¨ Ù…ÛŒâ€ŒØ¯ÛŒ","Ø¹Ø§Ø´Ù‚ØªÙ…","Ú†Ø±Ø§ Ø§Ø®Ù…Ùˆ Ø´Ø¯ÛŒ","Ú†ÛŒ Ú¯ÙØªÛŒ","Ù…Ù† Ú©ÛŒÙ…","ØªÙˆ Ú©ÛŒ Ù‡Ø³ØªÛŒ","Ú†Ø±Ø§ Ø§ÙˆÙ…Ø¯ÛŒ",
    "Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡","Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ…","Ù…Ù†Ùˆ ÛŒØ§Ø¯Øª Ù‡Ø³Øª","Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø³Ú©ÙˆØª Ú©Ù†ÛŒÙ…","Ø¯Ø§Ø±ÛŒ Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒ","Ø§Ø² Ù…Ù† Ø¨Ø¯Øª Ù…ÛŒØ§Ø¯",
]

# ================== ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± ==================
def auto_learn_from_text(text: str) -> str:
    mood = random.choice(list(MOODS.keys()))
    pattern = random.choice([
        f"{text}ØŸ Ø¬Ø§Ù„Ø¨Ù‡ ğŸ¤”",
        f"{text}! Ø¹Ø¬Ø¨ ğŸ˜…",
        f"ØªÙˆ Ú¯ÙØªÛŒ: {text}ØŸ Ù…Ù†Ù… Ù‡Ù…ÛŒÙ†Ù‡ Ø±Ùˆ Ø­Ø³ Ú©Ø±Ø¯Ù… {random.choice(['ğŸ˜','ğŸ˜…','ğŸ˜‚'])}",
        f"{text} Ø±Ùˆ Ú¯ÙØªÛŒØŸ Ù…Ù†Ù… Ù‡Ù… Ù…ÙˆØ§ÙÙ‚Ù…!",
        f"Ù…ÛŒâ€ŒØ¯ÙˆÙ†ÛŒØŸ {text} Ø¨Ø§Ø¹Ø« Ø´Ø¯ Ù„Ø¨Ø®Ù†Ø¯ Ø¨Ø²Ù†Ù… ğŸ˜„",
    ])
    return f"{pattern} ({mood})"

# ================== Ø³Ø§Ø®Øª Ù…ØºØ² ==================
def build_brain(n=40000):
    print("ğŸ§  Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù…ØºØ² Ø®ÙÙ†Ú¯ÙˆÙ„... Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù† ğŸ’ª")
    phrases = {}
    for i in range(n):
        base = random.choice(BASE_PHRASES)
        mood, replies = random.choice(list(MOODS.items()))
        resp = random.choice(replies)
        if random.random() < 0.3:
            resp = auto_learn_from_text(base)
        phrases[f"{base}_{i}"] = [resp]

    with open(OUT_JSON, "w", encoding="utf-8") as f:
        json.dump({"phrases": phrases}, f, ensure_ascii=False, indent=2)

    with zipfile.ZipFile(OUT_ZIP, "w", compression=zipfile.ZIP_DEFLATED) as z:
        z.write(OUT_JSON, arcname="memory.json")

    size = os.path.getsize(OUT_ZIP)
    print(f"âœ… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯: {OUT_ZIP} ({size/1024/1024:.2f} MB)")
    return OUT_ZIP, size

# ================== Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¯Ùˆ ==================
async def send_zip(path: str):
    token = os.getenv("BOT_TOKEN")
    admin = int(os.getenv("ADMIN_ID", "7089376754"))
    if not token:
        raise RuntimeError("BOT_TOKEN Ø¯Ø± Config Vars ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡.")
    bot = Bot(token=token)
    await bot.send_document(
        chat_id=admin,
        document=InputFile(path),
        caption=f"ğŸ§  Ù…ØºØ² Ø®ÙÙ†Ú¯ÙˆÙ„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Øª!\nğŸ“¦ ÙØ§ÛŒÙ„ ZIP: <code>{os.path.basename(path)}</code>\nØ§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ùˆ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø¨ÙØ±Ø³Øª Ùˆ /restore Ø¨Ø²Ù† â¤ï¸",
        parse_mode="HTML"
    )
    print("ğŸ“¨ ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¯Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.")

# ================== Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ ==================
if __name__ == "__main__":
    zip_path, size = build_brain(n=40000)
    if size < 50000:
        print("âš ï¸ ZIP Ø®ÛŒÙ„ÛŒ Ú©ÙˆÚ†Ú© Ø§Ø³ØªØ› Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø³Ø§Ø®Øª Ø®Ø±Ø§Ø¨ Ø´Ø¯Ù‡.")
    else:
        asyncio.run(send_zip(zip_path))
