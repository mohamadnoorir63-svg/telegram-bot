import random
import re
from memory_manager import get_reply, enhance_sentence, shadow_learn

# ======================= ๐ ุชุดุฎุต ุงุญุณุงุณ =======================
def detect_emotion(text: str) -> str:
    """ุชุญูู ูพุดุฑูุชู ุงุญุณุงุณ ุฌููู ุจุฑุง ูุงฺฉูุด ุทุจุนโุชุฑ"""
    if not text:
        return "neutral"

    text = text.lower()

    emotions = {
        "happy": ["๐", "๐คฃ", "๐", "ุฎูุดุญุงูู", "ุนุงูู", "ุฏูุช ฺฏุฑู", "ุฎูุจู", "ูุฑุณ", "โค๏ธ"],
        "sad": ["๐", "๐ข", "ุบูฺฏูู", "ุจุฏู ูุงุฏ", "ุฏูู ฺฏุฑูุชู", "ุงูุณุฑุฏู"],
        "angry": ["๐ก", "ูุนูุช", "ุญุฑุตู", "ุนุตุจุงู", "ุจุฏุจุฎุช", "ุฎูู ุดู"],
        "love": ["ุฏูุณุชุช ุฏุงุฑู", "โค๏ธ", "๐", "ุนุงุดูุชู", "ุนุดู", "ููุจู"],
        "question": ["?", "ฺุฑุง", "ฺู", "ฺ ุดุฏ", "ฺฉุฌุง", "ฺฉุฌุง", "ฺุทูุฑ"]
    }

    for emo, words in emotions.items():
        for w in words:
            if w in text:
                return emo

    return "neutral"

# ======================= ๐ฌ ูพุงุณุฎ ููุดููุฏ =======================
def smart_response(text: str, emotion: str) -> str:
    """ูพุงุณุฎ ูพูุงุ ุทุจุน ู ุงุฏฺฏุฑูุฏู ุจุฑ ุงุณุงุณ ุงุญุณุงุณ"""
    if not text:
        return ""

    # ูพุงุณุฎโูุง ูพุงู
    responses = {
        "happy": [
            "๐ ุฎูุดุญุงูู ุญุงูุช ุฎูุจู!",
            "๐ ุจุฎูุฏ ฺฉู ุฏูุง ุจุฎูุฏู!",
            "๐ ฺู ุญุณ ุฎูุจ!",
            "โจ ููุดู ุจุฎูุฏ ุชุง ุฏูุง ุจุฎูุฏู!"
        ],
        "sad": [
            "๐ข ูฺฏุฑุงู ูุจุงุดุ ุฏุฑุณุช ูุดู.",
            "๐ ุจุนุฏ ุดุจ ุชุงุฑฺฉุ ุตุจุญ ุฑูุดู ูุงุฏ.",
            "๐ ุฏูู ุจุฑุงุช ู ฺุง ุฏุงุบ ูโุฎูุงุฏ.",
        ],
        "angry": [
            "๐ค ุขุฑูู ุจุงุด ุฑูู...",
            "๐ก ุงุฑุฒุด ุนุตุจ ุดุฏู ูุฏุงุฑู!",
            "๐ง ู ููุณ ุนูู ุจฺฉุด ู ููุด ฺฉู.",
        ],
        "love": [
            "โค๏ธ ููู ุงุฒ ุชู ุฎูุดู ูุงุฏ ๐ณ",
            "๐ ุฎุฌุงูุช ูฺฉุด ๐",
            "๐ ุนุดู ุชู ููุง ูพุฎุดู!",
            "๐น ุญุณ ุฎูุจู ููุช ฺฉ ูฺฏู ุงูู!"
        ],
        "question": [
            "๐ค ุณูุงู ุฎูุจูุ ุจุฒุงุฑ ูฺฉุฑ ฺฉูู...",
            "๐ ุณูุงู ุณุฎุชู ูู ุฌุงูุจู!",
            "๐ง ุณูุงู ุจุงุนุซ ุฑุดุฏ ุฐูู ูุดู!",
            "๐ ุฌูุงุจ ุงูู ุดุงุฏ ุชู ุญุงูุธูโู ูพุฏุง ฺฉูู..."
        ],
        "neutral": [
            "๐ ุฌุงูุจู...",
            "๐ถ ุจุงุดู...",
            "๐ ุญูู!",
            "๐ค ูู ฺฏูุด ูโุฏู...",
            "๐ ุงุฏุงูู ุจุฏู..."
        ],
    }

    # ุชูุงุด ุจุฑุง ูพุงุณุฎ ุงุฒ ุญุงูุธู
    mem_reply = get_reply(text)
    if mem_reply:
        shadow_learn(text, mem_reply)
        return enhance_sentence(mem_reply)

    # ณฐูช ุงุญุชูุงู ุชุบุฑ ููุฏ ุจู ุฎูุซ ุจุฑุง ุทุจุนโุชุฑ ุดุฏู
    if random.random() < 0.3:
        emotion = "neutral"

    # ูพุงุณุฎ ููุง ุชุฑฺฉุจ ุงุฒ ุซุงุจุช + ุจูุจูุฏ ุฌููู
    base = random.choice(responses.get(emotion, responses["neutral"]))
    return enhance_sentence(base)
