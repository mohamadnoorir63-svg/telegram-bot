import json
import os
import random
from datetime import datetime
from fix_memory import fix_json

FILE = "shadow_memory.json"

# ========================= ðŸ“‚ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ =========================
def init_shadow():
    if not os.path.exists(FILE):
        with open(FILE, "w", encoding="utf-8") as f:
            json.dump({"hidden": {}}, f, ensure_ascii=False, indent=2)
    print("ðŸŒ™ Ø­Ø§ÙØ¸Ù‡â€ŒÛŒ Ø³Ø§ÛŒÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª.")

# ========================= ðŸ’¾ Ø¹Ù…Ù„ÛŒØ§Øª Ù¾Ø§ÛŒÙ‡ =========================
def load_shadow():
    try:
        with open(FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except json.JSONDecodeError:
        print("âš ï¸ JSON Ø®Ø±Ø§Ø¨ Ø¯Ø± shadow_memory.json â€” Ø¯Ø± Ø­Ø§Ù„ ØªØ¹Ù…ÛŒØ±...")
        fix_json(FILE)
        with open(FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception:
        return {"hidden": {}}

def save_shadow(data):
    try:
        with open(FILE, "w", encoding="utf-8") as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§ÙØ¸Ù‡ Ø³Ø§ÛŒÙ‡: {e}")

# ========================= ðŸ§  ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø³Ø§ÛŒÙ‡ =========================
def shadow_learn(phrase, response):
    """Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ ØªØµØ§Ø¯ÙÛŒ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡â€ŒÛŒ Ø³Ø§ÛŒÙ‡"""
    if not phrase or not response:
        return

    phrase, response = phrase.strip(), response.strip()
    data = load_shadow()

    if phrase not in data["hidden"]:
        data["hidden"][phrase] = [{"text": response, "weight": 1}]
    else:
        # Ø§Ú¯Ø± Ù¾Ø§Ø³Ø® ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨Ø§Ø´Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        existing_texts = [r["text"] for r in data["hidden"][phrase]]
        if response not in existing_texts:
            data["hidden"][phrase].append({"text": response, "weight": 1})

    save_shadow(data)
    print(f"ðŸŒ‘ [Shadow Learn] '{phrase}' â†’ '{response}'")

# ========================= ðŸ’¬ Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡ÛŒ Ø³Ø§ÛŒÙ‡ =========================
def shadow_reply(text):
    """Ù¾Ø§Ø³Ø® ØªØµØ§Ø¯ÙÛŒ Ø§Ø² Ø­Ø§ÙØ¸Ù‡ Ø³Ø§ÛŒÙ‡"""
    data = load_shadow().get("hidden", {})
    matches = [k for k in data.keys() if k in text]
    if not matches:
        return None

    key = random.choice(matches)
    responses = data[key]

    # Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ²Ù†
    weights = [r["weight"] for r in responses]
    chosen = random.choices(responses, weights=weights, k=1)[0]

    # Ø§ÙØ²Ø§ÛŒØ´ ÙˆØ²Ù† Ù¾Ø§Ø³Ø® Ù…Ù†ØªØ®Ø¨
    chosen["weight"] = min(chosen.get("weight", 1) + random.randint(1, 2), 10)

    # Ú©Ø§Ù‡Ø´ Ø¬Ø²Ø¦ÛŒ ÙˆØ²Ù† Ø³Ø§ÛŒØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
    for r in responses:
        if r != chosen and r["weight"] > 1:
            r["weight"] -= 1

    save_shadow({"hidden": data})

    reply = chosen["text"]
    if random.random() < 0.3:
        reply += " " + random.choice(["ðŸ˜", "ðŸ˜‰", "ðŸ˜„", "ðŸ˜…", "ðŸ¤­", "âœ¨"])

    return reply
