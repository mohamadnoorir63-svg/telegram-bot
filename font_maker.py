import random
import asyncio
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import ContextTypes, ConversationHandler, MessageHandler, CallbackQueryHandler, filters

ASK_NAME = 1

# ======================= ğŸ¨ ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ =======================
async def font_maker(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    chat_type = update.effective_chat.type

    # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ú¯Ø±ÙˆÙ‡
    if chat_type in ["group", "supergroup"]:
        msg = await update.message.reply_text(
            "âœ¨ Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª ÙÙˆÙ†ØªØŒ Ø¨Ù‡ Ù¾ÛŒÙˆÛŒ Ø±Ø¨Ø§Øª Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯ ğŸ™"
        )
        await asyncio.sleep(6)
        try:
            await msg.delete()
            await update.message.delete()
        except:
            pass
        return ConversationHandler.END

    if text == "ÙÙˆÙ†Øª":
        await update.message.reply_text("ğŸŒ¸ Ú†Ù‡ Ø§Ø³Ù…ÛŒ Ø±Ùˆ Ø¨Ø±Ø§Øª ÙÙˆÙ†Øª Ú©Ù†Ù…ØŸ")
        return ASK_NAME

    if text.startswith("ÙÙˆÙ†Øª "):
        name = text.replace("ÙÙˆÙ†Øª", "").strip()
        return await send_fonts(update, context, name)

    return ConversationHandler.END


# ======================= ğŸŒ¸ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø³Ù… =======================
async def receive_font_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    name = update.message.text.strip()
    return await send_fonts(update, context, name)


# ======================= ğŸ’ Ø§Ø±Ø³Ø§Ù„ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ =======================
async def send_fonts(update: Update, context: ContextTypes.DEFAULT_TYPE, name: str):
    fonts = generate_fonts(name)
    context.user_data["all_fonts"] = fonts
    context.user_data["font_pages"] = make_pages(name, fonts, 10, 5)

    pages = context.user_data["font_pages"]
    await update.message.reply_text(
        pages[0]["text"],
        parse_mode="HTML",
        reply_markup=pages[0]["keyboard"]
    )
    return ConversationHandler.END


# ======================= ğŸ­ ØªÙˆÙ„ÛŒØ¯ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ Ø´ÛŒÚ© =======================
def generate_fonts(name: str):
    pre_groups = [
        ["ğ“„‚",""ğ“ƒ¬","ğ“‹¥","ğ“„¼","ğ“‚€","ğ“…“"],
        ["êª°","êª´","ğ„ ","ğ…”","ê§","ê§‚","ê•¥"],
        ["âš","â˜¬","â˜¾","â˜½","â˜…","âœ¦","âœ§"]
    ]
    post_groups = [
        ["âœ¿","â™¡","â–","â–‘","â‹","â˜¯","â‚"],
        ["âœ§","âœ¦","â‚","â˜…","âœº","âœ¶","âœ¸"],
        ["â‹†","âŸ¡","â‹","â€¢","âœ¾","âœ¢","âœ¤"]
    ]
    unicode_styles = [
        (
            "ğ“ğ“‘ğ“’ğ““ğ“”ğ“•ğ“–ğ“—ğ“˜ğ“™ğ“šğ“›ğ“œğ“ğ“ğ“Ÿğ“ ğ“¡ğ“¢ğ“£ğ“¤ğ“¥ğ“¦ğ“§ğ“¨ğ“©"
            "ğ“ªğ“«ğ“¬ğ“­ğ“®ğ“¯ğ“°ğ“±ğ“²ğ“³ğ“´ğ“µğ“¶ğ“·ğ“¸ğ“¹ğ“ºğ“»ğ“¼ğ“½ğ“¾ğ“¿ğ”€ğ”ğ”‚ğ”ƒ",
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
        ),
        (
            "ğŸ„°ğŸ„±ğŸ„²ğŸ„³ğŸ„´ğŸ„µğŸ„¶ğŸ„·ğŸ„¸ğŸ„¹ğŸ„ºğŸ„»ğŸ„¼ğŸ„½ğŸ„¾ğŸ„¿ğŸ…€ğŸ…ğŸ…‚ğŸ…ƒğŸ…„ğŸ……ğŸ…†ğŸ…‡ğŸ…ˆğŸ…‰"
            "ğŸ„°ğŸ„±ğŸ„²ğŸ„³ğŸ„´ğŸ„µğŸ„¶ğŸ„·ğŸ„¸ğŸ„¹ğŸ„ºğŸ„»ğŸ„¼ğŸ„½ğŸ„¾ğŸ„¿ğŸ…€ğŸ…ğŸ…‚ğŸ…ƒğŸ…„ğŸ……ğŸ…†ğŸ…‡ğŸ…ˆğŸ…‰",
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
            "ğŸ…ğŸ…‘ğŸ…’ğŸ…“ğŸ…”ğŸ…•ğŸ…–ğŸ…—ğŸ…˜ğŸ…™ğŸ…šğŸ…›ğŸ…œğŸ…ğŸ…ğŸ…ŸğŸ… ğŸ…¡ğŸ…¢ğŸ…£ğŸ…¤ğŸ…¥ğŸ…¦ğŸ…§ğŸ…¨ğŸ…©"
        )   "ğ“ğ“‘ğ“’ğ““ğ“”ğ“•ğ“–ğ“—ğ“˜ğ“™ğ“šğ“›ğ“œğ“ğ“ğ“Ÿğ“ ğ“¡ğ“¢ğ“£ğ“¤ğ“¥ğ“¦ğ“§ğ“¨ğ“©"
            "â’¶â’·â’¸â’¹â’ºâ’»â’¼â’½â’¾â’¿â“€â“â“‚ï¸â“ƒâ“„â“…â“†â“‡â“ˆâ“‰â“Šâ“‹â“Œâ“â“â“"
            "ğŸ‡¦ ğŸ‡§ ğŸ‡¨ ğŸ‡© ğŸ‡ª ğŸ‡« ğŸ‡¬ ğŸ‡­ ğŸ‡® ğŸ‡¯ ğŸ‡° ğŸ‡± ğŸ‡² ğŸ‡³ ğŸ‡´ ğŸ‡µ ğŸ‡¶ ğŸ‡· ğŸ‡¸ ğŸ‡¹ ğŸ‡º ğŸ‡» ğŸ‡¼ ğŸ‡½ ğŸ‡¾ ğŸ‡¿"
            "ğ”¸ğ”¹â„‚ğ”»ğ”¼ğ”½ğ”¾â„ğ•€ğ•ğ•‚ğ•ƒğ•„â„•ğ•†â„™â„šâ„ğ•Šğ•‹ğ•Œğ•ğ•ğ•ğ•â„¤"
            "â’œâ’â’â’Ÿâ’ â’¡â’¢â’£â’¤â’¥â’¦â’§â’¨â’©â’ªâ’«â’¬â’­â’®â’¯â’°â’±â’²â’³â’´â’µ"
            "â“â“‘â“’â““â“”â“•â“–â“—â“˜â“™â“šâ“›â“œâ“â“â“Ÿâ“ â“¡â“¢â“£â“¤â“¥â“¦â“§â“¨â“©"
            "ğ—”ğ—•ğ—–ğ——ğ—˜ğ—™ğ—šğ—›ğ—œğ—ğ—ğ—Ÿğ— ğ—¡ğ—¢ğ—£ğ—¤ğ—¥ğ—¦ğ—§ğ—¨ğ—©ğ—ªğ—«ğ—¬ğ—­"
    ]
    fonts = []

    while len(fonts) < 50:
        pre = "".join(random.choice(group) for group in pre_groups)
        post = "".join(random.choice(group) for group in post_groups)
        style = random.choice(unicode_styles)
        # âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø·ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ø² maketrans
        if len(style[0]) != len(style[1]):
            continue
        uname = name.translate(str.maketrans(style[1], style[0]))
        fonts.append(f"{pre}{uname}{post}")

    return fonts


# ======================= ğŸ“„ Ø³Ø§Ø®Øª ØµÙØ­Ø§Øª =======================
def make_pages(name: str, fonts: list, page_size=10, max_pages=5):
    pages = []
    chunks = [fonts[i:i+page_size] for i in range(0, len(fonts), page_size)][:max_pages]
    for idx, chunk in enumerate(chunks):
        text = f"<b>â†» {name} â‡¦</b>\n:â€¢ Ù„ÛŒØ³Øª ÙÙˆÙ†Øª Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ :\n"
        keyboard = []
        for i, style in enumerate(chunk, start=1):
            global_index = idx*page_size + (i-1)
            text += f"{i}- {style}\n"
            keyboard.append([InlineKeyboardButton(f"{i}- {style}", callback_data=f"send_font_{global_index}")])
        text += f"\nğŸ“„ ØµÙØ­Ù‡ {idx+1} Ø§Ø² {len(chunks)}"

        nav = []
        if idx > 0: nav.append(InlineKeyboardButton("â¬…ï¸ Ù‚Ø¨Ù„ÛŒ", callback_data=f"prev_font_{idx-1}"))
        if idx < len(chunks)-1: nav.append(InlineKeyboardButton("â¡ï¸ Ø¨Ø¹Ø¯ÛŒ", callback_data=f"next_font_{idx+1}"))
        if nav: keyboard.append(nav)
        keyboard.append([InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="feature_back")])

        pages.append({"text": text, "keyboard": InlineKeyboardMarkup(keyboard)})
    return pages


# ======================= ğŸ“‹ Ø§Ø±Ø³Ø§Ù„ ÙÙˆÙ†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ =======================
async def send_selected_font(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    font_id = int(query.data.replace("send_font_", ""))
    all_fonts = context.user_data.get("all_fonts", [])
    if 0 <= font_id < len(all_fonts):
        await query.message.reply_text(all_fonts[font_id])
    else:
        await query.message.reply_text("â— ÙÙˆÙ†Øª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")


# ======================= ğŸ” ØµÙØ­Ø§Øª =======================
async def next_font(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    index = int(query.data.replace("next_font_", ""))
    pages = context.user_data.get("font_pages", [])
    if 0 <= index < len(pages):
        await query.edit_message_text(pages[index]["text"], parse_mode="HTML", reply_markup=pages[index]["keyboard"])


async def prev_font(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    index = int(query.data.replace("prev_font_", ""))
    pages = context.user_data.get("font_pages", [])
    if 0 <= index < len(pages):
        await query.edit_message_text(pages[index]["text"], parse_mode="HTML", reply_markup=pages[index]["keyboard"])


# ======================= ğŸ› Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ =======================
# ======================= ğŸ› Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ =======================
async def feature_back(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # Ø­Ø°Ù ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ÙØ¹Ù„ÛŒ ÙÙˆÙ†Øª
    try:
        await query.message.delete()
    except:
        pass

    # Ù¾Ø§ÛŒØ§Ù† ConversationHandler (Ø§Ú¯Ù‡ Ø¯Ø± Ø­ÛŒÙ† ConversationHandler Ù‡Ø³ØªÛŒÙ…)
    return ConversationHandler.END
