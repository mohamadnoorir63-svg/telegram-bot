# ================================================
# 🤖 خنگول مگابرین 4-حالته با یادگیری خودکار
# سازگار با سیستم بازیابی ربات (restore)
# ================================================
import json, os, zipfile, random

# مسیرها
BASE = os.path.dirname(os.path.abspath(__file__))
OUT_JSON = os.path.join(BASE, "memory.json")
OUT_ZIP = os.path.join("/app", "khengol_brain_4moods.zip")  # مسیر مطلق برای Heroku

# ==================== 🎭 حالت‌های گفتاری ====================
MOODS = {
    "😎 شوخ": [
        "😂 خندیدم به حرفت!",
        "عه جدی گفتی؟ 😂",
        "تو خیلی باحالی 😎",
        "دارم از خنده می‌میرم 🤣",
        "خنگی ولی دوست‌داشتنی 😂"
    ],
    "🫶 احساسی": [
        "دلم برات تنگ شده بود 😢",
        "تو همیشه خاصی برای من 💖",
        "چقدر حس خوبی دادی 😍",
        "آروم باش، من کنارت‌ام 💫",
        "ای کاش می‌تونستم بغلت کنم 🤗"
    ],
    "😡 تند": [
        "حرف دهنتو بفهم 😤",
        "زیاد حرف نزن 😒",
        "مواظب لحنِت باش 😠",
        "داری رو اعصابم راه میری 😑",
        "خفه شو دیگه 😡"
    ],
    "🧠 عادی": [
        "آره، متوجه شدم 🙂",
        "باشه، ادامه بده...",
        "جالبه 🤔",
        "منم همین فکرو می‌کردم 😌",
        "درسته ✅"
    ]
}

# ==================== 🧠 تابع یادگیری خودکار ====================
def auto_learn_from_text(text: str):
    """تولید پاسخ جدید از جمله واردشده به سبک طبیعی و خنده‌دار"""
    mood = random.choice(list(MOODS.keys()))
    pattern = random.choice([
        f"{text}؟ جالبه 🤔",
        f"{text}! عجب 😅",
        f"تو گفتی: {text}؟ منم همینه رو حس کردم {random.choice(['😏', '😅', '😂'])}",
        f"{text} رو گفتی؟ منم هم موافقم!",
        f"می‌دونی؟ {text} باعث شد لبخند بزنم 😄"
    ])
    return f"{pattern} ({mood})"

# ==================== ⚙️ تولید مغز هوشمند ====================
phrases = {}

print("🧠 در حال ساخت مغز خنگول فوق‌هوشمند... لطفاً صبر کن")

for i in range(50000):  # کمترش کردیم تا RAM هروکو جواب بده
    base = random.choice([
        "سلام", "خوبی", "چیکار می‌کنی", "دوستت دارم", "چته", "خفه شو",
        "کجایی", "برو بخواب", "دلت برام تنگ شده", "چی خوردی", "چرا ساکتی",
        "صبح بخیر", "شب بخیر", "حوصلم سر رفته", "می‌خوام بخندم", "چرا ناراحتی",
        "چقدر حرف می‌زنی", "بیکاری", "دوست داری منو", "چرا دیر جواب می‌دی",
        "عاشقتم", "چرا اخمو شدی", "چی گفتی", "من کیم", "تو کی هستی",
        "چرا اومدی", "حالت چطوره", "می‌خوای حرف بزنیم", "منو یادت هست",
        "دوست داری سکوت کنیم", "داری چیکار می‌کنی", "از من بدت میاد"
    ])
    mood, replies = random.choice(list(MOODS.items()))
    response = random.choice(replies)

    if random.random() < 0.3:
        response = auto_learn_from_text(base)

    phrases[f"{base}_{i}"] = [response]

# ذخیره در memory.json
memory_data = {"phrases": phrases}
with open(OUT_JSON, "w", encoding="utf-8") as f:
    json.dump(memory_data, f, ensure_ascii=False, indent=2)

# ساخت فایل زیپ
with zipfile.ZipFile(OUT_ZIP, "w", compression=zipfile.ZIP_DEFLATED) as zipf:
    zipf.write(OUT_JSON, arcname="memory.json")

# بررسی صحت
if os.path.getsize(OUT_ZIP) > 1000:
    print(f"✅ مغز هوشمند ساخته شد با {len(phrases):,} پاسخ!")
    print(f"📦 فایل خروجی: {OUT_ZIP}")
    print("💬 حالا فایل زیپ رو با دستور /restore برای ربات بفرست.")
else:
    print("⚠️ فایل ZIP خیلی کوچیکه، احتمالاً خطا در ساخت.")
